{
  "file_path": "docs/DATA_ARCHITECTURE_ANALYSIS.md",
  "title": "Data Architecture Analysis - ES vs PostgreSQL Separation",
  "document_type": "analysis",
  "content": "# Data Architecture Analysis - ES vs PostgreSQL Separation\n\n## Question: Why is \"no OSINT in PostgreSQL\" a problem?\n\n### Current State\n- **Elasticsearch**: 375 PDF documents (OSINT financial reports)\n- **PostgreSQL**: 0 messages with `osint` tag\n- **Observation**: Data is NOT propagated from ES \u2192 PG\n\n### Is this actually a problem? \ud83e\udd14\n\n## Architecture Philosophy: Separation of Concerns\n\n### Option 1: \u274c Full Replication (NOT RECOMMENDED)\n```\nElasticsearch (375 docs) \u2192 PostgreSQL (375 message records)\n```\n\n**Problems**:\n- \u274c Data duplication (ES already has metadata)\n- \u274c Scalability issue (375 docs * chunks = 1000s of PG rows)\n- \u274c Different usage patterns (ES = search index, PG = operational store)\n- \u274c Sync complexity (keep ES and PG in sync forever)\n- \u274c Wrong tool for the job (PG not designed for full-text search)\n\n### Option 2: \u2705 Smart References (RECOMMENDED)\n```\nElasticsearch (375 docs, source of truth)\n      \u2193 doc_id reference\nPostgreSQL (lightweight reference table)\n      \u2193 entity links\nNeo4j (document \u2192 agent/decision relationships)\n```\n\n**Benefits**:\n- \u2705 Single source of truth (ES for documents)\n- \u2705 Lightweight references in PG\n- \u2705 Proper separation of concerns\n- \u2705 Scalable (PG only stores metadata + references)\n- \u2705 Flexible queries via SearchOrchestrator\n\n## What SHOULD be in PostgreSQL?\n\n### 1. Document Reference Table\n```sql\nCREATE TABLE es_document_references (\n    id SERIAL PRIMARY KEY,\n    es_index TEXT NOT NULL,           -- 'osint_reports_pdf'\n    es_doc_id TEXT NOT NULL UNIQUE,   -- Elasticsearch document ID\n    doc_type TEXT,                    -- 'financial_report'\n    issuer TEXT,                      -- 'Grupa Azoty'\n    report_url TEXT,\n    indexed_at TIMESTAMP,\n    data_classification TEXT,         -- 'public', 'confidential'\n    investigation_id TEXT,            -- 'telus_cpk_real_001'\n    tags TEXT[]                       -- ['osint', 'financial', 'grupa-azoty']\n);\n\nCREATE INDEX idx_es_doc_refs_investigation ON es_document_references(investigation_id);\nCREATE INDEX idx_es_doc_refs_tags ON es_document_references USING GIN(tags);\n```\n\n**Size**: ~375 rows (one per PDF) = lightweight!\n\n### 2. Document Usage Log (Audit Trail)\n```sql\nCREATE TABLE es_document_usage_log (\n    id SERIAL PRIMARY KEY,\n    es_doc_id TEXT NOT NULL,\n    accessed_by TEXT NOT NULL,        -- agent name\n    access_timestamp TIMESTAMP DEFAULT NOW(),\n    query_used TEXT,                  -- original search query\n    access_purpose TEXT,              -- 'financial_analysis', 'osint_research'\n    session_id TEXT\n);\n```\n\n**Purpose**: Track who/when/why documents were accessed (GDPR compliance)\n\n### 3. Agent Context (Links to ES Documents)\n```sql\n-- Extend existing agent_contexts table\nINSERT INTO agent_contexts (agent_name, project_id, context_key, context_value)\nVALUES (\n    'Marcus',\n    'investigation-telus_cpk_real_001',\n    'osint_sources',\n    '{\"es_doc_ids\": [\"doc_123\", \"doc_456\"], \"count\": 375, \"issuer\": \"Grupa Azoty\"}'::jsonb\n);\n```\n\n**Purpose**: Agents know which ES documents are available for their investigation\n\n## What SHOULD NOT be in PostgreSQL?\n\n### \u274c Full Document Content\n- Content is already in ES (optimized for full-text search)\n- Duplication wastes space\n- Wrong tool (PG not designed for this)\n\n### \u274c Chunked Document Text\n- Chunks belong in ES (with highlighting) and Qdrant (with embeddings)\n- Don't replicate search index functionality in PG\n\n### \u274c Binary PDFs\n- PDFs stay in filesystem (`investigations/external/grupa_azoty_reports/`)\n- ES indexes text + metadata\n- PG only references\n\n## Recommended Data Flow\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     OSINT PDF Ingestion                      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                            \u2502\n                            \u25bc\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502  1. Store PDF in filesystem          \u2502\n         \u2502     investigations/external/...      \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                            \u2502\n            \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n            \u25bc               \u25bc               \u25bc\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502 Elasticsearch\u2502 \u2502  Qdrant    \u2502 \u2502 PostgreSQL  \u2502\n    \u2502              \u2502 \u2502            \u2502 \u2502             \u2502\n    \u2502 Full text +  \u2502 \u2502 Embeddings \u2502 \u2502 Reference + \u2502\n    \u2502 metadata     \u2502 \u2502 (chunks)   \u2502 \u2502 usage log   \u2502\n    \u2502              \u2502 \u2502            \u2502 \u2502             \u2502\n    \u2502 375 docs     \u2502 \u2502 ~1500 pts  \u2502 \u2502 375 refs    \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n            \u2502               \u2502               \u2502\n            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                            \u25bc\n                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502    Neo4j     \u2502\n                    \u2502              \u2502\n                    \u2502 doc\u2192agent    \u2502\n                    \u2502 doc\u2192decision \u2502\n                    \u2502 relationships\u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\n## Query Patterns (How Agents Use Data)\n\n### Pattern 1: Full-Text Search (Marcus finds financial reports)\n```python\norchestrator = SearchOrchestrator()\n\n# Query ES directly (no need for PG)\nreports = orchestrator.full_text_search(\n    query=\"przychody EBITDA\",\n    index=\"osint_reports_pdf\"\n)\n\n# Log usage to PG\nfor report in reports:\n    log_document_access(\n        es_doc_id=report.id,\n        accessed_by=\"Marcus\",\n        query=\"przychody EBITDA\",\n        purpose=\"financial_analysis\"\n    )\n```\n\n### Pattern 2: Check Available Sources (Elena checks what data exists)\n```python\n# Query PG for available sources\nsql = \"\"\"\n    SELECT issuer, COUNT(*) as doc_count, ARRAY_AGG(DISTINCT tags) as all_tags\n    FROM es_document_references\n    WHERE investigation_id = %s\n    GROUP BY issuer\n\"\"\"\nsources = orchestrator.structured_query(sql, ('telus_cpk_real_001',))\n```\n\n### Pattern 3: Audit Trail (Adrian checks who accessed data)\n```python\n# Query PG usage log\nsql = \"\"\"\n    SELECT accessed_by, COUNT(*) as access_count, \n           ARRAY_AGG(DISTINCT access_purpose) as purposes\n    FROM es_document_usage_log\n    WHERE es_doc_id = %s AND access_timestamp >= NOW() - INTERVAL '90 days'\n    GROUP BY accessed_by\n\"\"\"\naudit = orchestrator.structured_query(sql, ('doc_abc123',))\n```\n\n### Pattern 4: Hybrid Search (Helena combines sources)\n```python\n# SearchOrchestrator handles cross-layer queries automatically\nresults = orchestrator.hybrid_search(\n    query=\"financial trends\",\n    sources=['es', 'qdrant', 'pg'],  # PG returns references + usage stats\n    limit=10\n)\n```\n\n## Conclusion: Not a Bug, It's a Feature! \u2705\n\n### The \"gap\" is actually **good architecture**:\n\n1. **Elasticsearch** = Source of truth for OSINT documents\n   - Optimized for full-text search\n   - Handles 375 docs easily\n   - Scales to millions of documents\n\n2. **PostgreSQL** = References + Usage + Relationships\n   - Lightweight reference table (375 rows)\n   - Audit log (track access)\n   - Agent contexts (which docs are available)\n\n3. **Qdrant** = Semantic search\n   - Embeddings of document chunks\n   - Fast vector similarity\n\n4. **Neo4j** = Knowledge graph\n   - Links between documents and entities\n   - Relationship queries\n\n### What ACTUALLY needs to be done (Phase 2):\n\n\u2705 **Add reference table to PG**\n```sql\nCREATE TABLE es_document_references (...);\n```\n\n\u2705 **Add usage logging**\n```python\n@log_access\ndef full_text_search(...):\n    # logs to es_document_usage_log\n```\n\n\u2705 **Add Neo4j links**\n```cypher\nCREATE (doc:Document {es_doc_id: '...', issuer: 'Grupa Azoty'})\nCREATE (agent:Agent {name: 'Marcus'})\nCREATE (agent)-[:USED]->(doc)\n```\n\n\u2705 **Update agent contexts**\n```python\n# Helena tells agents: \"You have 375 OSINT docs available\"\ncontext = {\n    \"osint_sources\": {\n        \"es_index\": \"osint_reports_pdf\",\n        \"count\": 375,\n        \"issuers\": [\"Grupa Azoty\"],\n        \"coverage\": \"2007-2025\"\n    }\n}\n```\n\n## The Real \"Problem\" (if any)\n\nThe real issue is not \"data not in PG\" but rather:\n\n### \u274c Agents don't know OSINT data exists\n- No reference table \u2192 agents can't discover available sources\n- No context \u2192 agents don't know to query ES\n\n### \u274c No audit trail\n- Can't track who accessed which documents\n- GDPR compliance issue\n\n### \u274c No links in knowledge graph\n- Neo4j doesn't know documents exist\n- Can't answer \"which documents did Marcus use for this analysis?\"\n\n### \u2705 Solution: Lightweight integration (not full replication)\n- Create reference table (375 rows)\n- Log usage (append-only, grows over time)\n- Create Neo4j document nodes\n- Update agent contexts\n\n## Revised Phase 2 Priority\n\n### HIGH Priority \ud83d\udd34\n1. \u2705 Create `es_document_references` table in PG\n2. \u2705 Implement usage logging decorator\n3. \u2705 Sync references when PDFs are indexed\n4. \u2705 Update agent contexts with available sources\n\n### MEDIUM Priority \ud83d\udfe1\n5. Create Neo4j document nodes + relationships\n6. Build \"available sources\" query API\n7. Audit trail dashboard (Grafana/Kibana)\n\n### Result\n- Agents can **discover** OSINT data (via PG reference table)\n- Agents can **search** OSINT data (via ES full-text)\n- System can **audit** usage (via PG log)\n- Graph can **relate** documents to entities (via Neo4j)\n- No unnecessary data duplication \u2705\n",
  "indexed_at": "2025-11-04T21:20:55.610725",
  "source": "realtime_watcher"
}