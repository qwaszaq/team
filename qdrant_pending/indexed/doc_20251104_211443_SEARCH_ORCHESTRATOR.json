{
  "file_path": "docs/SEARCH_ORCHESTRATOR.md",
  "title": "SearchOrchestrator - Unified Search Interface",
  "document_type": "architecture",
  "content": "# SearchOrchestrator - Unified Search Interface\n\n## Overview\n\nSearchOrchestrator provides a unified API for querying across all Destiny framework data layers:\n- **Elasticsearch**: Full-text search, aggregations, time-series queries\n- **Qdrant**: Semantic/vector search using embeddings\n- **PostgreSQL**: Structured queries, metadata, relationships\n- **Neo4j**: Graph queries, decision chains, knowledge graphs\n\n## Architecture\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              SearchOrchestrator                          \u2502\n\u2502                                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502  Unified API                                    \u2502    \u2502\n\u2502  \u2502  - full_text_search()                          \u2502    \u2502\n\u2502  \u2502  - semantic_search()                           \u2502    \u2502\n\u2502  \u2502  - structured_query()                          \u2502    \u2502\n\u2502  \u2502  - graph_query()                               \u2502    \u2502\n\u2502  \u2502  - hybrid_search()                             \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502                                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502    ES    \u2502 \u2502  Qdrant  \u2502 \u2502 Postgres \u2502 \u2502  Neo4j   \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\n## Installation & Setup\n\n```python\nfrom search_orchestrator import SearchOrchestrator\n\n# Initialize with default settings\norchestrator = SearchOrchestrator()\n\n# Or customize connection parameters\norchestrator = SearchOrchestrator(\n    es_url=\"http://localhost:9200\",\n    es_user=\"elastic\",\n    es_password=\"changeme123\",\n    qdrant_url=\"http://localhost:6333\",\n    postgres_conn=\"dbname=destiny_team user=user password=password host=localhost\",\n    neo4j_container=\"sms-neo4j\",\n)\n```\n\n## Core Methods\n\n### 1. Full-Text Search (Elasticsearch)\n\n```python\n# Basic search\nresults = orchestrator.full_text_search(\n    query=\"financial performance\",\n    index=\"osint_reports_pdf\",\n    size=10,\n    highlight=True\n)\n\n# With filters\nresults = orchestrator.full_text_search(\n    query=\"revenue\",\n    index=\"osint_reports_pdf\",\n    filters={\"issuer.keyword\": \"Grupa Azoty\"}\n)\n\n# Results structure\nfor result in results:\n    print(f\"Score: {result.score}\")\n    print(f\"Content: {result.content}\")\n    print(f\"Metadata: {result.metadata}\")\n```\n\n### 2. Semantic Search (Qdrant)\n\n```python\n# Semantic/vector search\nresults = orchestrator.semantic_search(\n    query=\"sustainability and climate initiatives\",\n    collection=\"destiny-team-framework-master\",\n    limit=10\n)\n\n# Results are automatically ranked by semantic similarity\n```\n\n### 3. Structured Query (PostgreSQL)\n\n```python\n# Direct SQL query\nresults = orchestrator.structured_query(\n    sql=\"SELECT * FROM messages WHERE sender = %s LIMIT %s\",\n    params=(\"Elena\", 10)\n)\n\n# Get agent context\ncontext = orchestrator.get_context_for_agent(\n    agent_name=\"Marcus\",\n    project_id=\"destiny-team-framework-master\",\n    limit=5\n)\n```\n\n### 4. Graph Query (Neo4j)\n\n```python\n# Cypher query\nresults = orchestrator.graph_query(\n    cypher=\"MATCH (d:Decision) RETURN d.text, d.timestamp LIMIT 10\"\n)\n\n# Get decision chain\ndecisions = orchestrator.get_decision_chain(\n    decision_keyword=\"architecture\",\n    limit=5\n)\n```\n\n### 5. Hybrid Search (Multi-Source)\n\n```python\n# Search across ES + Qdrant + Postgres\nresults = orchestrator.hybrid_search(\n    query=\"system integration\",\n    sources=['es', 'qdrant', 'pg'],\n    limit=10,\n    rerank=True  # Re-rank by score\n)\n\n# Results are combined and optionally re-ranked\n```\n\n## Aggregations\n\n```python\n# Elasticsearch aggregations\naggs = orchestrator.aggregate_query(\n    index=\"osint_reports_pdf\",\n    agg_field=\"issuer.keyword\",\n    agg_name=\"by_issuer\",\n    size=10\n)\n\n# Time-series aggregation example\naggs = orchestrator.aggregate_query(\n    index=\"osint_reports_pdf\",\n    agg_field=\"downloaded_at\",\n    agg_name=\"by_month\",\n    agg_type=\"date_histogram\"\n)\n```\n\n## Health & Monitoring\n\n```python\n# Check backend health\nhealth = orchestrator.health_check()\n# Returns: {'elasticsearch': True, 'qdrant': True, 'postgres': True, 'neo4j': True}\n\n# Get statistics\nstats = orchestrator.get_stats()\n# Returns: {'elasticsearch_docs': 375, 'qdrant_points': 409, 'postgres_messages': 108}\n```\n\n## Use Cases\n\n### 1. Financial Analysis (Marcus)\n\n```python\n# Find revenue-related reports\nreports = orchestrator.full_text_search(\n    query=\"przychody zysk EBITDA\",\n    index=\"osint_reports_pdf\",\n    highlight=True\n)\n\n# Aggregate by year\nyearly_stats = orchestrator.aggregate_query(\n    index=\"osint_reports_pdf\",\n    agg_field=\"report_year\",\n    agg_name=\"by_year\"\n)\n```\n\n### 2. OSINT Research (Elena)\n\n```python\n# Semantic search for topics\nresults = orchestrator.semantic_search(\n    query=\"corporate governance and compliance\",\n    limit=20\n)\n\n# Full-text search with filters\nfiltered_results = orchestrator.full_text_search(\n    query=\"board decisions\",\n    filters={\"data_classification\": \"public\"}\n)\n```\n\n### 3. Compliance Audit (Adrian)\n\n```python\n# Check data lineage\naudit_trail = orchestrator.structured_query(\n    sql=\"\"\"\n        SELECT es_doc_id, report_url, indexed_at, last_accessed\n        FROM es_document_metadata\n        WHERE indexed_at >= NOW() - INTERVAL '90 days'\n        ORDER BY indexed_at DESC\n    \"\"\"\n)\n```\n\n### 4. Knowledge Management (Helena)\n\n```python\n# Get agent context\ncontext = orchestrator.get_context_for_agent(\"Helena\")\n\n# Check decision chain\ndecisions = orchestrator.get_decision_chain(\"data_propagation\")\n\n# Hybrid search for briefing\nbriefing_data = orchestrator.hybrid_search(\n    query=\"recent system changes\",\n    sources=['es', 'qdrant', 'pg'],\n    limit=20\n)\n```\n\n## SearchResult Object\n\nAll search methods return `SearchResult` objects:\n\n```python\n@dataclass\nclass SearchResult:\n    source: str          # 'elasticsearch', 'qdrant', 'postgres', 'neo4j'\n    score: float         # Relevance score\n    content: str         # Main content/excerpt\n    metadata: Dict       # Full metadata\n    id: str             # Document/point ID\n    timestamp: str      # Optional timestamp\n```\n\n## Error Handling\n\nSearchOrchestrator handles errors gracefully:\n\n```python\n# If Elasticsearch is down, returns empty list []\nresults = orchestrator.full_text_search(\"query\")\n\n# Health check shows which backends are available\nhealth = orchestrator.health_check()\nif not health['elasticsearch']:\n    print(\"Elasticsearch unavailable, using fallback...\")\n    results = orchestrator.semantic_search(\"query\")  # Use Qdrant instead\n```\n\n## Performance Considerations\n\n### Query Optimization\n\n1. **Use filters**: Reduce result set before scoring\n2. **Limit size**: Only fetch what you need\n3. **Disable highlighting**: If not needed for display\n4. **Use aggregations**: Instead of fetching all documents\n\n```python\n# Optimized query\nresults = orchestrator.full_text_search(\n    query=\"keyword\",\n    size=10,                          # Small size\n    highlight=False,                  # Disable if not needed\n    filters={\"issuer.keyword\": \"...\"}  # Pre-filter\n)\n```\n\n### Caching\n\nFor repeated queries, consider caching results:\n\n```python\nfrom functools import lru_cache\n\n@lru_cache(maxsize=100)\ndef cached_search(query: str):\n    return orchestrator.full_text_search(query)\n```\n\n## Integration with Agents\n\n### Agent Base Class Extension\n\n```python\nfrom search_orchestrator import SearchOrchestrator\n\nclass BaseAgent:\n    def __init__(self):\n        self.search = SearchOrchestrator()\n    \n    def gather_context(self, query: str):\n        # Hybrid search for agent context\n        return self.search.hybrid_search(\n            query=query,\n            sources=['es', 'qdrant', 'pg'],\n            limit=10\n        )\n```\n\n### Example: Financial Agent\n\n```python\nclass FinancialAgent(BaseAgent):\n    def analyze_company(self, company_name: str):\n        # Get financial reports\n        reports = self.search.full_text_search(\n            query=f\"{company_name} financial statements\",\n            index=\"osint_reports_pdf\",\n            filters={\"issuer.keyword\": company_name}\n        )\n        \n        # Extract metrics (simplified)\n        metrics = []\n        for report in reports:\n            # Parse content for financial figures\n            metrics.append(self._extract_metrics(report))\n        \n        return metrics\n```\n\n## Roadmap\n\n### Phase 1 (Weeks 1-2) \u2705 COMPLETED\n- [x] Core SearchOrchestrator class\n- [x] ES, Qdrant, Postgres, Neo4j integration\n- [x] Hybrid search\n- [x] Health checks and monitoring\n- [x] Usage examples\n\n### Phase 2 (Weeks 3-4) - NEXT\n- [ ] Advanced aggregations (date_histogram, nested)\n- [ ] Query builder DSL\n- [ ] Result caching layer\n- [ ] Async/parallel queries\n- [ ] Enhanced error handling and retry logic\n\n### Phase 3 (Weeks 5-6)\n- [ ] Agent-specific search profiles\n- [ ] Query performance analytics\n- [ ] Auto-suggest and query expansion\n- [ ] Integration with Helena's briefing system\n- [ ] Production deployment configuration\n\n## Testing\n\nRun tests:\n\n```bash\n# Basic functionality\npython3 search_orchestrator.py\n\n# Agent usage examples\npython3 examples/search_orchestrator_usage.py\n\n# Unit tests (coming in Phase 2)\npytest tests/test_search_orchestrator.py -v\n```\n\n## Troubleshooting\n\n### Elasticsearch connection fails\n```bash\n# Check ES health\ncurl -u elastic:changeme123 http://localhost:9200/_cluster/health\n\n# Restart ES container\ndocker restart hercules-elasticsearch\n```\n\n### Qdrant returns empty results\n```bash\n# Check collections\ncurl http://localhost:6333/collections\n\n# Verify embeddings service is running (LM Studio on port 1234)\n```\n\n### PostgreSQL connection error\n```bash\n# Test connection\npsql -h localhost -U user -d destiny_team -c \"SELECT 1\"\n```\n\n## Contributing\n\nTo extend SearchOrchestrator:\n\n1. Add new method to class\n2. Follow existing naming conventions\n3. Return `SearchResult` objects for consistency\n4. Add usage example\n5. Update documentation\n\n## License\n\nPart of the Destiny Framework. See main project LICENSE.\n\n## Support\n\nFor issues or questions:\n- Check examples in `examples/search_orchestrator_usage.py`\n- Review integration concept in `investigations/concepts/elasticsearch_integration_*.json`\n- Contact: Knowledge Management Team (Helena)\n",
  "indexed_at": "2025-11-04T21:14:43.237968",
  "source": "realtime_watcher"
}